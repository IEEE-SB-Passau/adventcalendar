@import org.ieee_passau.controllers.Beans.SolutionListEntry
@import org.ieee_passau.models.{Language, Queued, User}
@(solutions: List[SolutionListEntry], languages: List[Language], door: Int, showAll: Boolean = false)(implicit sessionUser: Option[User], messages: Messages)

<div id="solutionlist">
    @solutionList(solutions, languages)
</div>

<script type="text/javascript">
    (function () {
        var whileQueuedInterval = 1000, noneQueuedInterval = 10000;
        var solutions = {};

        window.addEventListener("load", function () {

            $("#solutionlist").find(">div").each(function (i, element) {
                element = $(element);
                solutions[element.attr("id")] = {status: element.data("state"), element: element};
            });

            function setExpandedStateTo(jqSelector, expanded) {
                if (expanded && jqSelector.attr("aria-expanded") !== "true") {
                    jqSelector.addClass("in");
                    jqSelector.attr("aria-expanded", "true");
                } else if (!expanded && jqSelector.attr("aria-expanded") === "true") {
                    jqSelector.removeClass("in");
                    jqSelector.attr("aria-expanded", "false");
                }
            }

            function checkSolutionUpdates() {
                $.ajax({
                    url: "@org.ieee_passau.controllers.routes.MainController.getUserProblemSolutions(door)"
                }).done(function (data) {
                    var queuedSolutionPresent = false;

                    $.each(data, function (i, solutionInfo) {
                        var solution = solutions[solutionInfo.id];

                        if (solution === undefined) {
                            return;
                        }

                        if (solution.status === '@Queued.name' || solution.status !== solutionInfo.result) {
                            solution.status = solutionInfo.result;

                            if (solution.unprocessedHtml === undefined || solution.unprocessedHtml !== solutionInfo.html) {

                                // save expanded-states
                                var wasExpanded = solution.element.find("#solution" + solutionInfo.id).attr("aria-expanded") === "true";
                                var wasSourceExpanded = solution.element.find("#code" + solutionInfo.id).attr("aria-expanded") === "true";
                                var wasTestcaseExpanded = {};
                                solution.element.find("#solution" + solutionInfo.id + " .testcase-collapse").each(function (i, element) {
                                    wasTestcaseExpanded[element.id] = $(this).attr("aria-expanded") === "true";
                                });

                                // update HTML
                                solution.unprocessedHtml = solutionInfo.html;
                                solution.element.html(solutionInfo.html);

                                // restore expanded-states
                                setExpandedStateTo(solution.element.find("#solution" + solutionInfo.id), wasExpanded);
                                setExpandedStateTo(solution.element.find("#code" + solutionInfo.id), wasSourceExpanded);
                                solution.element.find("#solution" + solutionInfo.id + " .testcase-collapse").each(function (i, element) {
                                    if (wasTestcaseExpanded[element.id] !== undefined) {
                                        setExpandedStateTo($(this), wasTestcaseExpanded[element.id]);
                                    }
                                });

                                // re-add syntax-highlighting
                                hljs.highlightBlock(solution.element.find("pre code")[0]);

                                // re-calculate diff
                                var expected = solution.element.find(".expected-output")[0];
                                var actual = solution.element.find(".actual-output")[0];
                                if (actual != null && expected != null) {
                                    diffNodes(expected, actual);
                                }
                            }

                            if (solution.status === '@Queued.name') {
                                queuedSolutionPresent = true;
                            }
                        }
                    });

                    setTimer(queuedSolutionPresent);
                });
            }

            function setTimer(queuedSolutionPresent) {
                window.setTimeout(checkSolutionUpdates, (queuedSolutionPresent) ? whileQueuedInterval : noneQueuedInterval);
            }

            (function () {
                var queuedSolutionPresent = false;

                $.each(solutions, function (i, solution) {
                    if (solution.status === '@Queued.name') {
                        queuedSolutionPresent = true;
                    }
                });

                setTimer(queuedSolutionPresent);
            })();
        });
    })();
</script>
